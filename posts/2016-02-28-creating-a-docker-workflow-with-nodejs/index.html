<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Creating a Docker Workflow with Node.js - bchoy.me</title><meta name="Description" content="bchoy.me"><meta property="og:title" content="Creating a Docker Workflow with Node.js" />
<meta property="og:description" content="Note: These are my findings after working with Docker, Jenkins, and AWS for only 2-3 months. This post details my thought process for the workflow I have set up with Docker and was written to document my progress. However, it might be useful for other beginners who are interested in setting up a better workflow for development with Node.js and Docker.
The Problem
Our development team occasionally has to switch between different projects. Each project has its own set of dependencies requiring a specific version of Node.js, npm, and/or Ruby to be run. Using nvm and rvm can mitigate the issue, but constantly switching between versions is a hassle and it is easy to lose track of which version you&rsquo;re currently using. Time is also wasted on debugging environment inconsistencies between local development machines, and even more time is lost solving cross-platform issues when deploying to the dev/qa/prod servers (OSX to Linux). Many hours were lost for both the development and system administration teams debugging these issues; hours that could instead be spent improving the current project or working on other projects." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchoy.me/posts/2016-02-28-creating-a-docker-workflow-with-nodejs/" /><meta property="og:image" content="https://bchoy.me/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-02-28T16:40:28+00:00" />
<meta property="article:modified_time" content="2016-02-28T16:40:28+00:00" /><meta property="og:site_name" content="bchoy.me" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://bchoy.me/logo.png"/>

<meta name="twitter:title" content="Creating a Docker Workflow with Node.js"/>
<meta name="twitter:description" content="Note: These are my findings after working with Docker, Jenkins, and AWS for only 2-3 months. This post details my thought process for the workflow I have set up with Docker and was written to document my progress. However, it might be useful for other beginners who are interested in setting up a better workflow for development with Node.js and Docker.
The Problem
Our development team occasionally has to switch between different projects. Each project has its own set of dependencies requiring a specific version of Node.js, npm, and/or Ruby to be run. Using nvm and rvm can mitigate the issue, but constantly switching between versions is a hassle and it is easy to lose track of which version you&rsquo;re currently using. Time is also wasted on debugging environment inconsistencies between local development machines, and even more time is lost solving cross-platform issues when deploying to the dev/qa/prod servers (OSX to Linux). Many hours were lost for both the development and system administration teams debugging these issues; hours that could instead be spent improving the current project or working on other projects."/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://bchoy.me/posts/2016-02-28-creating-a-docker-workflow-with-nodejs/" /><link rel="prev" href="https://bchoy.me/posts/2015-12-28-dockerizing-a-node-application/" /><link rel="next" href="https://bchoy.me/posts/2017-12-26-overthewire-bandit/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Creating a Docker Workflow with Node.js",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/bchoy.me\/posts\/2016-02-28-creating-a-docker-workflow-with-nodejs\/"
        },"genre": "posts","wordcount":  1946 ,
        "url": "https:\/\/bchoy.me\/posts\/2016-02-28-creating-a-docker-workflow-with-nodejs\/","datePublished": "2016-02-28T16:40:28+00:00","dateModified": "2016-02-28T16:40:28+00:00","license": "bchoy.me","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Brian Choy"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="bchoy.me">bchoy.me</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Blog </a><a class="menu-item" href="/about"> About </a><a class="menu-item" href="/resume"> Resume </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="bchoy.me">bchoy.me</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Blog</a><a class="menu-item" href="/about" title="">About</a><a class="menu-item" href="/resume" title="">Resume</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Creating a Docker Workflow with Node.js</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://bchoy.me" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Brian Choy</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="02-28-2016">02-28-2016</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1946 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;10 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem">The Problem</a></li>
    <li><a href="#proposed-solution">Proposed Solution</a></li>
    <li><a href="#setting-up-docker">Setting up Docker</a>
      <ul>
        <li><a href="#bootstrapping-and-dealing-with-node-modules">Bootstrapping and Dealing with Node Modules</a></li>
        <li><a href="#tackling-file-watching">Tackling File Watching</a></li>
        <li><a href="#the-problem-with-docker-osx-dev">The Problem with docker-osx-dev</a></li>
        <li><a href="#running-the-project">Running the Project</a></li>
      </ul>
    </li>
    <li><a href="#using-jenkins">Using Jenkins</a></li>
    <li><a href="#future-changes">Future Changes</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><strong>Note:</strong> These are my findings after working with Docker, Jenkins, and AWS for only 2-3 months. This post details my thought process for the workflow I have set up with Docker and was written to document my progress. However, it might be useful for other beginners who are interested in setting up a better workflow for development with Node.js and Docker.</p>
<h2 id="the-problem">The Problem</h2>
<p>Our development team occasionally has to switch between different projects. Each project has its own set of dependencies requiring a specific version of Node.js, npm, and/or Ruby to be run. Using nvm and rvm can mitigate the issue, but constantly switching between versions is a hassle and it is easy to lose track of which version you&rsquo;re currently using. Time is also wasted on debugging environment inconsistencies between local development machines, and even more time is lost solving cross-platform issues when deploying to the dev/qa/prod servers (OSX to Linux). Many hours were lost for both the development and system administration teams debugging these issues; hours that could instead be spent improving the current project or working on other projects.</p>
<h2 id="proposed-solution">Proposed Solution</h2>
<p>We needed a standardized environment, reproducible across our developer&rsquo;s machines, Jenkins servers, and production servers. The two most popular technologies that solve this problem are Vagrant and Docker. Vagrant and Docker also helps us onboard new developers much more quickly. Before we started using Docker, new developers would have to follow a lengthy readme, download every necessary dependency, and configure their installations. Despite following the readme exactly, there may be some issues due to setups from previous projects and additional time is spent troubleshooting. With Vagrant and Docker, the environment is already preconfigured and isolated, allowing a new developer to get started with much less hassle.</p>
<p>I chose to use Docker for our workflow primarily because of how lightweight it is. Running an entire virtual machine uses more system resources than running containers. Also, our front end projects all require Node.js, npm, and compass. Creating an image and using it as a base for all projects makes more sense than using Vagrant to run a completely isolated virtual machine for each one. Switching between projects is much faster and having a virtual machine for each project when they have very similar environments seems redundant. Furthermore, our Jenkins servers are running on small AWS EC2 instances. The overhead of multiple virtual machines on a machine is much more than having containers spun up from Docker images created from the same base image.</p>
<h2 id="setting-up-docker">Setting up Docker</h2>
<p>Since our company is in the beginning stages of embracing the DevOps philosophy, I&rsquo;ve made the decision to keep our setup simple for now. As we feel more comfortable with using Docker, I&rsquo;ll be setting up private repos on Docker Hub, Quay, or AWS ECR. At the moment, I have an image on a public repo serving as the project base. This image contains everything the application needs to run and compile assets with gulp and compass.</p>
<p>Base Dockerfile:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> debian:8.3</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">MAINTAINER</span><span class="s"> Brian Choy &lt;bchoy@barbariangroup.com&gt;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">NODE_VERSION</span><span class="o">=</span><span class="m">4</span>.3.1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">NPM_VERSION</span><span class="o">=</span>3.7.3<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> ln -snf /bin/bash /bin/sh<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    apt-get update <span class="o">&amp;&amp;</span> apt-get install -y --no-install-recommends <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      curl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      git <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      ca-certificates <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      libpng12-dev <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      pngquant <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>      ruby-compass<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh <span class="p">|</span> sh<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    cp -f ~/.nvm/nvm.sh ~/.nvm/nvm-tmp.sh<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;nvm install </span><span class="si">${</span><span class="nv">NODE_VERSION</span><span class="si">}</span><span class="s2">; nvm alias default </span><span class="si">${</span><span class="nv">NODE_VERSION</span><span class="si">}</span><span class="s2">; ln -s ~/.nvm/versions/node/v</span><span class="si">${</span><span class="nv">NODE_VERSION</span><span class="si">}</span><span class="s2">/bin/node /usr/bin/node; ln -s ~/.nvm/versions/node/v</span><span class="si">${</span><span class="nv">NODE_VERSION</span><span class="si">}</span><span class="s2">/bin/npm /usr/bin/npm&#34;</span> &gt;&gt; ~/.nvm/nvm-tmp.sh<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh ~/.nvm/nvm-tmp.sh<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    rm ~/.nvm/nvm-tmp.sh<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    npm config <span class="nb">set</span> registry https://registry.npmjs.org/<span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    npm install -g npm@<span class="si">${</span><span class="nv">NPM_VERSION</span><span class="si">}</span><span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    npm <span class="nb">set</span> <span class="nv">progress</span><span class="o">=</span>false<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/bin/bash&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>I am using the Debian 8.3 base image because it&rsquo;s small enough, comes with a necessary packages out of the box, and has the correct version of ruby-compass that I need. The scope of our current work allows me to get away with the extra bloat. We also have just started using Docker. Optimizing and tweaking the base Docker image can be done later in case we run into issues and decide to favour Vagrant or another technology. Having additional bloat is well worth the time I would have spent building our project base image from a smaller base and finding out exactly what dependencies are needed.</p>
<h3 id="bootstrapping-and-dealing-with-node-modules">Bootstrapping and Dealing with Node Modules</h3>
<p>I have written an init.sh script to quickly create the containers needed and install the Node modules.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Creating node_modules container...&#34;</span>
</span></span><span class="line"><span class="cl">docker create -v /tmp/app --name node-modules thebarbariangroup/node-compass /bin/true
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Installing node_modules to container...&#34;</span>
</span></span><span class="line"><span class="cl">docker run --rm --volumes-from node-modules -v <span class="nv">$PWD</span>/package.json:/tmp/app/package.json:ro thebarbariangroup/node-compass /bin/bash -c <span class="s2">&#34;cd /tmp/app; npm install&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Done!&#34;</span>
</span></span></code></pre></div><p>The script creates a <code>node-modules</code> container specifically containing the node_modules folder. Node modules will be installed to <code>/tmp/app</code> and will be mounted onto the gulp container. A few months ago when I first started working with Docker, I&rsquo;ve seen many tutorials suggest installing Node modules with the Dockerfile.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">COPY</span> package.json package.json<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> npm install<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;gulp&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>The idea behind the above approach is to cache the Node modules by only installing them when <code>package.json</code> is changed. This makes sense, however if I want to add or remove modules, every single module will have to be reinstalled. Waiting a few minutes whenever a package needs to be installed disrupts the workflow for every developer and a lot of time is lost. By setting up a separate container, I avoid the need to cache Node modules. <code>package.json</code> is copied to <code>/tmp/app</code> as read-only and <code>$ npm install</code> is run with the new <code>package.json</code> on that container. The only change in workflow is remembering to run the init script instead of <code>$ npm install</code>. I was unable to overwrite its default function and use my script. More info on the solution I used can be found reading <a href="https://github.com/npm/npm/issues/8836" target="_blank" rel="noopener noreffer ">this GitHub issue</a>.</p>
<p>In addition to this, npm&rsquo;s progress bar was adding an incredible amount of build time. This issue can be viewed <a href="https://github.com/npm/npm/issues/11283" target="_blank" rel="noopener noreffer ">here</a> and is resolved by turning the progress bar off: <code>$ npm set progress=false</code>. The slowdown has been addressed and fixed in <a href="https://github.com/npm/npm/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreffer ">npm v3.7.0</a>.</p>
<h3 id="tackling-file-watching">Tackling File Watching</h3>
<p>Gulp&rsquo;s watch task is essential to our workflow. Unfortunately, due to a limitation in VirtualBox, inotify-based file watchers do not work. Polling can be enabled, but it is slow and we&rsquo;re used to seeing our changes almost instantly. The best solution I&rsquo;ve found for this is using rsync to send files to Docker-Machine. The <a href="https://github.com/brikis98/docker-osx-dev" target="_blank" rel="noopener noreffer ">docker-osx-dev project</a> packages the rsync setup in a nice, easy to use script easily installable with brew.</p>
<p>Once installed, any developer working on the project will have to run the docker-osx-dev script and file watching will be enabled. One nice feature is directories and files listed in the <code>.dockerignore</code> file are automatically not included. I was facing issues with my changes not being seen on the Docker container. Simply adding the generated static assets to the <code>.dockerignore</code> file fixed my problems.</p>
<h3 id="the-problem-with-docker-osx-dev">The Problem with docker-osx-dev</h3>
<p>docker-osx-dev is great when all your developers are on OSX. Very recently one of our projects required us to support development on Windows, and the docker-osx-dev script was no longer a valid solution. This is where Vagrant came into play for me. I used Vagrant to provision the environment and set up shared folders using rsync for both Windows and OSX (Linux untested). Unfortunately, setup for Windows still has additional steps because rsync is not installed by default. Cygwin, MinGW or cwRsync has to be installed and the latest Vagrant (1.8.1) has a bug where paths are not read correctly. Using the following solutions from these two GitHub issues fixed my rsync issues and allowed me to work on my Windows environment using cwRsync.
<a href="https://github.com/mitchellh/vagrant/issues/6702#issuecomment-166503021" target="_blank" rel="noopener noreffer ">https://github.com/mitchellh/vagrant/issues/6702#issuecomment-166503021</a>
<a href="https://github.com/mitchellh/vagrant/issues/3230#issuecomment-37757086" target="_blank" rel="noopener noreffer ">https://github.com/mitchellh/vagrant/issues/3230#issuecomment-37757086</a></p>
<h3 id="running-the-project">Running the Project</h3>
<p>Since I&rsquo;m using an already compiled image, my actual Dockerfile in this project is very short.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> thebarbariangroup/node-compass</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">MAINTAINER</span><span class="s"> Brian Choy &lt;bchoy@barbariangroup.com&gt;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /src/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> ln -s /tmp/app/node_modules node_modules<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 3000</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;npm&#34;</span><span class="p">,</span> <span class="s2">&#34;run&#34;</span><span class="p">,</span> <span class="s2">&#34;dockerdev&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>This will symlink the Node modules in the node-modules container (which is mounted as a volume) and allow the application to use the modules from that container.</p>
<p>To run gulp, I&rsquo;ve modified <code>$ npm start</code> to run this shell script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>docker <span class="nb">kill</span> node
</span></span><span class="line"><span class="cl">docker rm node
</span></span><span class="line"><span class="cl">docker rmi <span class="k">$(</span>docker images -f <span class="s2">&#34;dangling=true&#34;</span> -q<span class="k">)</span>
</span></span><span class="line"><span class="cl">docker build -t thebarbariangroup/projectname .
</span></span><span class="line"><span class="cl">docker run -it <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --name node <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --volumes-from node-modules <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/app:/src/app/app <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -p 3000:3000 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        thebarbariangroup/projectname
</span></span></code></pre></div><p><strong>Note:</strong> The names I&rsquo;m using for my containers (node-modules and node) are placeholders. More specific names should be used to avoid confusion with multiple projects.</p>
<p>When the project is built, the previous lingering container will be killed if running, and removed. Dangling images (blank image names) are also removed to keep your image list clean and free up disk space. Docker by default does not have a cleanup feature.</p>
<p>The new <code>node</code> image will now build and a container will be run in interactive mode, allowing you to see gulp&rsquo;s output. The node-modules container is mounted as a volume, and my <code>app</code> folder (where my html, js, sass is contained) is mounted onto the new <code>node</code> container, enabling me to view my changes while developing. Port 3000 on the host is mapped to port 3000 on the container and <code>$ npm dockerdev</code> (a custom npm script to run gulp) is run. For some reason I&rsquo;m unable to run gulp directly due to a <code>gulp not found</code> error, despite it being installed. I&rsquo;m unsure as to why this happens.</p>
<p>Your project is now visible on your Docker-Machine&rsquo;s IP on port 3000. To see your Docker-Machine IP, run <code>$ docker-machine [vm name] ip</code>. In my hosts file, I pointed <code>projectname</code> to my Docker-Machine IP so I can visit http://projectname:3000 to view my app.</p>
<h2 id="using-jenkins">Using Jenkins</h2>
<p>Jenkins is the final step in our workflow. After a change is pushed to GitHub, Jenkins will build the container using the <code>$ gulp build:production</code> command and the static assets will be built in the container. To retrieve these assets, the files need to be copied from the container over to a directory on the Jenkin server&rsquo;s filesystem.
<code>$ docker cp projectname:/file/path/within/container /host/path/target</code></p>
<p>Jenkins will then take those compiled assets and upload them to an EC2 instance running Apache. Apache will then serve the newly compiled assets.</p>
<p><strong>Note:</strong> I set up Docker manually in Jenkins when I started this project, but I&rsquo;m looking forward to trying out <a href="https://wiki.jenkins-ci.org/display/JENKINS/Docker&#43;build&#43;step&#43;plugin" target="_blank" rel="noopener noreffer ">the Docker Build Step plugin</a> on my next project.</p>
<h2 id="future-changes">Future Changes</h2>
<p>Revising the base image and updating all projects is easy. The Dockerfile for my base image shown earlier installs a specific Node.js and npm version. In hindsight, I realized that those versions should be specified in each project&rsquo;s individual Dockerfile instead of in the base. That way each project can start out with an installation of nvm, but install its own version. I did not notice my error until after I introduced the Docker workflow to all of the developers. Fortunately, updating the base image was not a problem. This is how I handled my mistake.</p>
<p>After removing the Node.js and npm installations from the Dockerfile for my base Docker image, I pushed the image up with the <code>1.0.0</code> tag. I reference this version number in my project&rsquo;s Dockerfile:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> thebarbariangroup/node-compass:1.0.0</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">MAINTAINER</span><span class="s"> Brian Choy &lt;bchoy@barbariangroup.com&gt;</span><span class="err">
</span></span></span></code></pre></div><p>Going forward, I will be tagging my base builds with a version number. Versioning the base image allows for more versatile updates. Now all developers will get the latest changes with a <code>git pull</code> because the Dockerfile is checked into the GitHub repo. Docker will handle the pulling of the latest image. Furthermore, different projects can reference different versions of the base image. If I chose to update my base image with more packages, future projects can point to <code>thebarbariangroup/node-compass:2.0.0</code> while older projects that do not need those packages can still reference <code>1.0.0</code>.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 02-28-2016</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2015-12-28-dockerizing-a-node-application/" class="prev" rel="prev" title="Dockerizing a Node Application"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Dockerizing a Node Application</a>
            <a href="/posts/2017-12-26-overthewire-bandit/" class="next" rel="next" title="OverTheWire Bandit">OverTheWire Bandit<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2015 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://bchoy.me" target="_blank">Brian Choy</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-F9RPBWE7GE', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-F9RPBWE7GE" async></script></body>
</html>
